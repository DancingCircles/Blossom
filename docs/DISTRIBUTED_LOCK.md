# åˆ†å¸ƒå¼é”å®ç°è¯´æ˜

## âœ… åŠŸèƒ½æ¦‚è¿°

åŸºäº **Redis SETNX + Luaè„šæœ¬** å®ç°çš„åˆ†å¸ƒå¼é”ï¼Œç”¨äºé˜²æ­¢é«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚

---

## ğŸ—ï¸ æŠ€æœ¯å®ç°

### æ ¸å¿ƒåŸç†

1. **åŠ é”**ï¼šä½¿ç”¨ `SET key value NX EX seconds` å‘½ä»¤
   - `NX`ï¼šåªåœ¨é”®ä¸å­˜åœ¨æ—¶è®¾ç½®ï¼ˆåŸå­æ“ä½œï¼‰
   - `EX`ï¼šè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢æ­»é”
   - `value`ï¼šä½¿ç”¨UUIDä½œä¸ºå”¯ä¸€æ ‡è¯†

2. **è§£é”**ï¼šä½¿ç”¨ Lua è„šæœ¬ä¿è¯åŸå­æ€§
   ```lua
   if redis.call("get", KEYS[1]) == ARGV[1] then
       return redis.call("del", KEYS[1])
   else
       return 0
   end
   ```
   - åªæœ‰æŒæœ‰é”çš„å®¢æˆ·ç«¯æ‰èƒ½é‡Šæ”¾é”
   - é˜²æ­¢è¯¯åˆ å…¶ä»–å®¢æˆ·ç«¯çš„é”

3. **è¶…æ—¶æœºåˆ¶**ï¼š
   - è‡ªåŠ¨è¿‡æœŸæ—¶é—´ï¼šé˜²æ­¢å®¢æˆ·ç«¯å´©æºƒå¯¼è‡´æ­»é”
   - é‡è¯•æœºåˆ¶ï¼š`TryLock` æ”¯æŒå¤šæ¬¡å°è¯•è·å–é”

---

## ğŸ“ åº”ç”¨åœºæ™¯

### 1. æŠ•ç¥¨åŠŸèƒ½ï¼ˆ`logic/topic.go`ï¼‰

**é—®é¢˜**ï¼šç”¨æˆ·å¿«é€Ÿç‚¹å‡»å¯èƒ½å¯¼è‡´é‡å¤æŠ•ç¥¨æˆ–è®¡æ•°é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```go
lockKey := fmt.Sprintf("lock:vote:%d:%d", topicID, userID)
utils.WithLock(ctx, redis.GetClient(), lockKey, 3*time.Second, func() error {
    // æŸ¥è¯¢æŠ•ç¥¨è®°å½•
    // æ›´æ–°æŠ•ç¥¨è®°å½•
    // æ›´æ–°è¯é¢˜è®¡æ•°
    return nil
})
```

**é”Keyè®¾è®¡**ï¼š`lock:vote:{topic_id}:{user_id}`
- ç²’åº¦ï¼šé’ˆå¯¹ç‰¹å®šç”¨æˆ·+ç‰¹å®šè¯é¢˜
- è¶…æ—¶ï¼š3ç§’ï¼ˆè¶³å¤Ÿå®ŒæˆæŠ•ç¥¨æ“ä½œï¼‰

### 2. è¯„è®ºåŠŸèƒ½ï¼ˆ`logic/comment.go`ï¼‰

**é—®é¢˜**ï¼šç”¨æˆ·çŸ­æ—¶é—´å†…é‡å¤æäº¤ç›¸åŒè¯„è®º

**è§£å†³æ–¹æ¡ˆ**ï¼š
```go
lockKey := fmt.Sprintf("lock:comment:%d:%d", topicID, userID)
utils.WithLock(ctx, redis.GetClient(), lockKey, 2*time.Second, func() error {
    // æ’å…¥è¯„è®º
    // æ›´æ–°è¯é¢˜è¯„è®ºæ•°
    return nil
})
```

**é”Keyè®¾è®¡**ï¼š`lock:comment:{topic_id}:{user_id}`
- ç²’åº¦ï¼šé’ˆå¯¹ç‰¹å®šç”¨æˆ·+ç‰¹å®šè¯é¢˜
- è¶…æ—¶ï¼š2ç§’ï¼ˆé˜²æ­¢é‡å¤æäº¤ï¼‰

---

## ğŸ”§ API ä½¿ç”¨

### æ–¹å¼1ï¼šè‡ªåŠ¨ç®¡ç†ï¼ˆæ¨èï¼‰

```go
import "web_app/utils"

err := utils.WithLock(ctx, redisClient, "my:lock:key", 5*time.Second, func() error {
    // ä¸šåŠ¡é€»è¾‘
    return nil
})
```

**ä¼˜ç‚¹**ï¼š
- è‡ªåŠ¨è·å–å’Œé‡Šæ”¾é”
- defer ä¿è¯é”ä¸€å®šè¢«é‡Šæ”¾
- ä»£ç ç®€æ´

### æ–¹å¼2ï¼šæ‰‹åŠ¨ç®¡ç†

```go
lock := utils.NewDistributedLock(redisClient, "my:lock:key", 5*time.Second)

// è·å–é”
if err := lock.Lock(ctx); err != nil {
    return err
}
defer lock.Unlock(ctx) // ç¡®ä¿é‡Šæ”¾é”

// ä¸šåŠ¡é€»è¾‘
```

### æ–¹å¼3ï¼šå¸¦é‡è¯•

```go
lock := utils.NewDistributedLock(redisClient, "my:lock:key", 5*time.Second)

// é‡è¯•5æ¬¡ï¼Œæ¯æ¬¡é—´éš”200ms
err := lock.TryLock(ctx, 5, 200*time.Millisecond)
if err != nil {
    return err
}
defer lock.Unlock(ctx)
```

---

## âœ… æµ‹è¯•éªŒè¯

æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²é€šè¿‡å•å…ƒæµ‹è¯•ï¼š

```bash
cd web_app
go test -v ./utils -run TestDistributedLock
```

æµ‹è¯•è¦†ç›–ï¼š
- âœ… åŸºæœ¬åŠ é”/è§£é”
- âœ… å¹¶å‘å®‰å…¨ï¼ˆ10ä¸ªåç¨‹åªæœ‰1ä¸ªè·å¾—é”ï¼‰
- âœ… å¸¦é‡è¯•çš„åŠ é”
- âœ… WithLockè¾…åŠ©å‡½æ•°

---

## ğŸ¯ è®¾è®¡ä¼˜åŠ¿

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **åŸå­æ€§** | Redis SET NX EX ä¿è¯åŠ é”åŸå­æ€§ |
| **å®‰å…¨æ€§** | UUIDé˜²æ­¢è¯¯åˆ ï¼ŒLuaè„šæœ¬ä¿è¯è§£é”åŸå­æ€§ |
| **å®¹é”™æ€§** | è‡ªåŠ¨è¿‡æœŸé˜²æ­¢æ­»é” |
| **é«˜æ€§èƒ½** | Rediså†…å­˜æ“ä½œï¼Œå¾®ç§’çº§å“åº” |
| **æ˜“ç”¨æ€§** | `WithLock` è¾…åŠ©å‡½æ•°ï¼Œè‡ªåŠ¨ç®¡ç†é”ç”Ÿå‘½å‘¨æœŸ |
| **ç²¾ç¡®ç²’åº¦** | é’ˆå¯¹å…·ä½“æ“ä½œè®¾è®¡é”Keyï¼Œä¸å½±å“å…¶ä»–æ“ä½œ |

---

## ğŸ“Š æ€§èƒ½å½±å“

- **åŠ é”è€—æ—¶**ï¼š< 1msï¼ˆRediså†…å­˜æ“ä½œï¼‰
- **è§£é”è€—æ—¶**ï¼š< 1msï¼ˆLuaè„šæœ¬æ‰§è¡Œï¼‰
- **æ€»å¼€é”€**ï¼š< 2msï¼ˆå¯¹æ¥å£å“åº”æ—¶é—´å½±å“å¯å¿½ç•¥ï¼‰

---

## ğŸš€ ç”Ÿäº§ç¯å¢ƒå»ºè®®

1. **åˆç†è®¾ç½®è¶…æ—¶æ—¶é—´**
   - æŠ•ç¥¨ï¼š3ç§’ï¼ˆæŸ¥è¯¢+æ›´æ–°ï¼‰
   - è¯„è®ºï¼š2ç§’ï¼ˆæ’å…¥+è®¡æ•°ï¼‰
   - æ ¹æ®å®é™…ä¸šåŠ¡é€»è¾‘è°ƒæ•´

2. **é”Keyå‘½åè§„èŒƒ**
   - æ ¼å¼ï¼š`lock:{operation}:{resource_id}:{user_id}`
   - ç¤ºä¾‹ï¼š`lock:vote:12345:67890`

3. **ç›‘æ§ä¸å‘Šè­¦**
   - ç›‘æ§é”è·å–å¤±è´¥ç‡
   - å‘Šè­¦é”è¶…æ—¶æ¬¡æ•°è¿‡å¤š
   - å®šæœŸæ£€æŸ¥Redisé”æ®‹ç•™

4. **å¼‚å¸¸å¤„ç†**
   - è·å–é”å¤±è´¥ï¼šè¿”å›å‹å¥½æç¤º"æ“ä½œè¿‡äºé¢‘ç¹"
   - è¶…æ—¶é‡Šæ”¾é”ï¼šä¸å½±å“åç»­è¯·æ±‚
   - Rediså®•æœºï¼šé™çº§ä¸ºæ— é”æ¨¡å¼ï¼ˆå¯é€‰ï¼‰

---

## ğŸ“ ä»£ç ä½ç½®

- **å®ç°**ï¼š`web_app/utils/distributed_lock.go`
- **æµ‹è¯•**ï¼š`web_app/utils/distributed_lock_test.go`
- **ä½¿ç”¨**ï¼š
  - `web_app/logic/topic.go` - VoteTopic
  - `web_app/logic/comment.go` - CreateComment

